@page "/product/edit/{id?}"
@inject HttpClient Http
@inject NavigationManager navigationManager
<h2><a href="product" class="text-dark" style="text-decoration:none">
    <span class="fas fa-arrow-left"></span></a> Edit a product</h2>
@if (!isLoaded)
{
    <p><em>Loading...</em></p>
}
else
{
    <EditForm Model="@model" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <div>
            <div class="row @(string.IsNullOrEmpty(message) ? "d-none": "")">
                <div class="col-sm-12">
                    <div class="alert alert-@messageType">
                        @message
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4">
                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="Pictures"><i style="width:20px" class="fas fa-images"></i></span>
                            </div>
                            <div class="custom-file">
                                <InputFile OnChange="@LoadFiles" multiple accepts="images/*" class="custom-file-input" aria-label="Pictures" aria-describedby="Pictures" />
                                <label class="custom-file-label" for="Picture">Choose picture</label>
                            </div>
                        </div>
                        <div class="small">
                            <ValidationMessage For="@(() => model.Pictures)" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <div id="carouselExampleControls" class="carousel border" data-ride="carousel">
                            <div class="carousel-inner text-center" style="height:200px">
                                @if (isLoadingFile)
                                {
                                    <p><em>Loading...</em></p>
                                }
                                else
                                {
                                    int i = 0;                                   
                                    {
                                        foreach (var file in model.Pictures)
                                        {
                                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                                <img class="img-fluid" style="max-height:200px" src="@file.Path" alt="@file.Name">
                                            </div>
                                            i++;
                                        }
                                    }
                                }
                            </div>
                            <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                        </div>
                        <a href="javascript:;" class="text-danger small" @onclick="clearFiles">Clear</a>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="Reference"><i style="width:20px" class="fas fa-barcode"></i></span>
                            </div>
                            <InputText @bind-Value="model.Reference" type="text" maxlength="5" s class="form-control text-uppercase" placeholder="Product code" aria-label="Reference" aria-describedby="Reference" />
                        </div>
                        <div class="small">
                            <ValidationMessage For="@(() => model.Reference)" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="Name"><i style="width:20px" class="fas fa-tag"></i></span>
                            </div>
                            <InputText @bind-Value="model.Name" class="form-control" placeholder="Product roduct name" aria-label="Name" aria-describedby="Name" />
                        </div>
                        <div class="small">
                            <ValidationMessage For="@(() => model.Name)" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="Price"><i style="width:20px" class="fas fa-money-bill-alt"></i></span>
                            </div>
                            <InputNumber @bind-Value="model.Price" class="form-control" placeholder="Product price" aria-label="Price" aria-describedby="Price" />
                        </div>
                        <div class="small">
                            <ValidationMessage For="@(() => model.Price)" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="Currency"><i style="width:20px" class="fas fa-dollar-sign"></i></span>
                            </div>
                            <InputText @bind-Value="model.Currency" class="form-control text-uppercase" placeholder="Product price currency" aria-label="Currency" aria-describedby="Currency" />
                        </div>
                        <div class="small">
                            <ValidationMessage For="@(() => model.Currency)" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="Owner"><i style="width:20px" class="far fa-copyright"></i></span>
                            </div>
                            <InputSelect @bind-Value="model.OwnerId" class="form-control" aria-label="Role" aria-describedby="Owner">
                                @if (model.Owners != null)
                                {
                                    <option value="">Choose the product owner</option>
                                    foreach (var owner in model.Owners)
                                    {
                                        <option value="@owner.Id">@owner.Fullname</option>
                                    }
                                }
                            </InputSelect>
                        </div>
                        <div class="small">
                            <ValidationMessage For="@(() => model.OwnerId)" />
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="mb-3">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="Descriptioname"><i style="width:20px" class="fas fa-info-circle"></i></span>
                            </div>
                            <InputTextArea style="height:145px" @bind-Value="model.Description" class="form-control" placeholder="Product description" aria-label="Description" aria-describedby="Description" />
                        </div>
                        <div class="small">
                            <ValidationMessage For="@(() => model.Description)" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="custom-control custom-checkbox mt-4">
                            <InputCheckbox class="custom-control-input" id="Status" @bind-Value="model.Status" />
                            <label class="custom-control-label" for="Status">Enable/Disable</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="input-group mt-4">
                            <button type="submit" disabled="@isBusy" class="btn btn-success btn-block">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </EditForm>

}
@code{
    private bool isBusy = false;
    private bool isLoadingFile = false;
    private bool isLoaded = true;
    private MessageType messageType = MessageType.danger;
    private string message = string.Empty;
    private ProductCreateModel model = new ProductCreateModel();
    private Entities.Product product = null;
    private EditContext context;
    private MultipartFormDataContent content = new MultipartFormDataContent();

    private long maxFileSize = 1024 * 1024 * 5;
    private int maxAllowedFiles = 6;

    [Parameter]
    public string Id { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoaded = false;
            var response = await Http.GetAsync($"account/owners");
            if (response.IsSuccessStatusCode)
            {
                var json = await response.Content.ReadAsStringAsync();
                var users = JsonConvert.DeserializeObject<IEnumerable<Entities.User>>(json);
                model.Owners = users.Select
                (
                    x =>
                    new UserCreateModel
                    (
                        x.Id,
                        x.Email,
                        null,
                        null,
                        x.FullName,
                        x.Role,
                        x.Status
                    )
                ).ToArray();
                if (!string.IsNullOrEmpty(Id))
                {
                    response = await Http.GetAsync($"article/{Id}");
                    if (response.IsSuccessStatusCode)
                    {
                        json = await response.Content.ReadAsStringAsync();
                        product = JsonConvert.DeserializeObject<Entities.Product>(json);
                        model = new ProductCreateModel
                        (
                            product.Key,
                            product.Reference,
                            product.Name,
                            product.Description,
                            product.Price,
                            product.Currency,
                            product.Pictures.Select(x => new FileInfoModel(x.Name, System.IO.Path.GetFileName(x.Name), 0, x.ContentType)).ToList(),
                            product.Owner?.Id,
                            model.Owners,
                            product.Status
                        );
                    }
                    else
                    {
                        messageType = MessageType.danger;
                        message = await response.Content.ReadAsStringAsync();
                    }
                }
            }
            else
            {
                messageType = MessageType.danger;
                message = await response.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            messageType = MessageType.danger;
            message = $"Error : {ex.Message}";
        }
        finally
        {
            isLoaded = true;
            context = new EditContext(model);
        }
    }

    private async Task HandleValidSubmit()
    {
        try
        {
            if (context.Validate())
            {
                isBusy = true;
                messageType = MessageType.info;
                message = "Processing...";

                if (string.IsNullOrEmpty(Id))
                {

                    content.Add
                    (
                        new StringContent
                        (
                            JsonConvert.SerializeObject
                            (
                                new Entities.Product
                                (
                                    null,
                                    model.Reference,
                                    model.Name,
                                    model.Description,
                                    model.Price ?? 0,
                                    model.Currency,
                                    model.Pictures.Select(x => new Entities.FileInfo(x.Name, x.ContentType)),
                                    model.OwnerId,
                                    null,
                                    DateTime.UtcNow,
                                    model.Status
                                )
                            ),
                            System.Text.Encoding.UTF8, "application/json"
                        ),
                        "\"Product\""
                    );
                    var response = await Http.PostAsync
                    (
                        $"article",
                        content
                    );
                    if (response.IsSuccessStatusCode)
                    {
                        model = new ProductCreateModel(model.Owners);
                        messageType = MessageType.success;
                        message = "Save done !";
                    }
                    else
                    {
                        messageType = MessageType.danger;
                        message = await response.Content.ReadAsStringAsync();
                    }
                }
                else
                {
                    content.Add
                    (
                        new StringContent
                        (
                            JsonConvert.SerializeObject
                            (
                                new Entities.Product
                                (
                                    product.Key,
                                    model.Reference,
                                    model.Name,
                                    model.Description,
                                    model.Price ?? 0,
                                    model.Currency,
                                    model.Pictures.Count == 0
                                    ? product.Pictures
                                    : model.Pictures.Select(x => new Entities.FileInfo(x.Name, x.ContentType)).ToArray(),
                                    model.OwnerId,
                                    null,
                                    product.CreatedAt,
                                    model.Status
                                )
                            ),
                            System.Text.Encoding.UTF8, "application/json"
                        ),
                        "Product"
                    );
                    var response = await Http.PutAsync
                    (
                        $"article/{Id}{model.Pictures == null}",
                        content
                    );
                    if (response.IsSuccessStatusCode)
                    {
                        messageType = MessageType.success;
                        message = "Save done !";
                        await Task.Delay(2000);
                        navigationManager.NavigateTo("product");
                    }
                    else
                    {
                        messageType = MessageType.danger;
                        message = await response.Content.ReadAsStringAsync();
                    }
                }
            }
        }
        catch (Exception ex)
        {
            messageType = MessageType.danger;
            message = $"Error : {ex.Message}";
        }
        finally
        {
            isBusy = false;
        }
    }

    async Task LoadFiles(InputFileChangeEventArgs e)
    {
        try
        {
            isBusy = true;
            isLoadingFile = true;
            //loadedFiles.Clear();

            foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
            {
                //using var reader =
                //    new StreamReader(file.OpenReadStream(maxFileSize));
                //var b = ReadFully(reader.BaseStream);
                model.Pictures.Add
                (
                    new FileInfoModel
                    {
                        Name = file.Name,
                        Size = file.Size,
                        Path = "data:" + file.ContentType + ";base64," + Convert.ToBase64String(await ReadFully(file.OpenReadStream(maxFileSize))),
                        ContentType = file.ContentType
                    }
                );
                content.Add
                (
                    new StreamContent
                    (
                        file.OpenReadStream()
                    ),
                    "\"pictures\"",
                    file.Name
                );
            }
        }
        catch (Exception ex)
        {
            messageType = MessageType.danger;
            message = $"Error : {ex.Message}";
        }
        finally
        {
            isBusy = false;
            isLoadingFile = false;
        }
    }

    void clearFiles()
    {
        model.Pictures.Clear();
        content = new MultipartFormDataContent();
    }

    private async Task<byte[]> ReadFully(System.IO.Stream input)
    {
        byte[] buffer = new byte[16 * 1024];
        using (var ms = new System.IO.MemoryStream())
        {
            int read;
            while ((read = await input.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                ms.Write(buffer, 0, read);
            }
            return ms.ToArray();
        }
    }
}